<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveAI</title>
<style>
html,body{margin:0;height:100%;background:black;font-family:system-ui}
#video{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover}
#bar{
position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
display:flex;gap:16px;background:rgba(0,0,0,.65);padding:18px 30px;
border-radius:50px;backdrop-filter:blur(20px)
}
.btn{width:56px;height:56px;border-radius:50%;border:none;
display:flex;align-items:center;justify-content:center;font-size:22px;color:white}
.red{background:#ff3b30}.gray{background:#444}.green{background:#34c759}
</style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>

<div id="bar">
<button class="btn gray" onclick="toggleMic()">ðŸŽ¤</button>
<button class="btn gray" onclick="toggleCam()">ðŸ“·</button>
<button class="btn green" onclick="startCall()">ðŸ“ž</button>
<button class="btn red" onclick="endCall()">âœ•</button>
</div>

<script>
let ws,stream,mediaRecorder,audioQueue=[]
const video=document.getElementById("video")

async function startCall(){
stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true})
video.srcObject=stream

ws=new WebSocket("wss://gemini-live-api-f0vo.onrender.com/ws")

const audioCtx=new AudioContext()
const src=audioCtx.createMediaStreamSource(stream)
const processor=audioCtx.createScriptProcessor(4096,1,1)
src.connect(processor);processor.connect(audioCtx.destination)

processor.onaudioprocess=e=>{
let data=e.inputBuffer.getChannelData(0)
let pcm=new Int16Array(data.length)
for(let i=0;i<data.length;i++)pcm[i]=data[i]*32767
let b64=btoa(String.fromCharCode(...new Uint8Array(pcm.buffer)))
ws.send(JSON.stringify({data:b64,mime_type:"audio/pcm"}))
}

ws.onmessage=e=>{
const msg=JSON.parse(e.data)
if(msg.audio){
const bytes=Uint8Array.from(atob(msg.audio),c=>c.charCodeAt(0))
audioCtx.decodeAudioData(bytes.buffer).then(b=>{
const s=audioCtx.createBufferSource()
s.buffer=b;s.connect(audioCtx.destination);s.start()
})
}}
}

function toggleMic(){stream.getAudioTracks()[0].enabled^=1}
function toggleCam(){stream.getVideoTracks()[0].enabled^=1}
function endCall(){location.reload()}
</script>
</body>
</html>
